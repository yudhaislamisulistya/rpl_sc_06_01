name: CI/CD - MLOps Komoditas

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

jobs:
  ci-build-test-train-docker:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install dependencies (di dalam folder 03_MLOps_Sample) -- requirements.txt
      - name: Install dependencies
        working-directory: 03_MLOps_Sample
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. (Opsional) Jalankan unit test jika folder tests/ ada
      - name: Run tests (if any)
        working-directory: 03_MLOps_Sample
        run: |
          if [ -d "tests" ]; then
            echo "Running pytest..."
            pip install pytest
            pytest
          else
            echo "No tests directory found, skipping tests."
          fi

      # 5. Jalankan training script: 03_MLOps_Sample/src/training/train.py
      - name: Run training script
        working-directory: 03_MLOps_Sample
        run: |
          if [ -f "src/training/train.py" ]; then
            python src/training/train.py
          else
            echo "src/training/train.py not found, skip training."
          fi

      # 6. Build Docker image (cek Dockerfile valid, belum push ke registry)
      - name: Build Docker image
        working-directory: 03_MLOps_Sample
        run: |
          docker build -t mlops-komoditas:${{ github.sha }} .

  deploy-to-server:
    needs: ci-build-test-train-docker
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to SSH server via appleboy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "=== Pindah ke home directory user ==="
            cd /home/yis

            echo "=== Cek apakah repo rpl_sc_06_01 sudah ada ==="
            if [ -d "rpl_sc_06_01/.git" ]; then
              echo "Direktori git ditemukan, pull origin main"
              cd rpl_sc_06_01
              sudo git pull origin main
            else
              echo "Direktori git tidak ditemukan, clone repo"
              sudo rm -rf rpl_sc_06_01 || true
              sudo git clone https://github.com/yudhaislamisulistya/rpl_sc_06_01.git
              cd rpl_sc_06_01
            fi

            echo "=== Masuk ke folder project 03_MLOps_Sample ==="
            cd 03_MLOps_Sample

            # check apakah ada pip atau tidak
            if ! command -v pip &> /dev/null
            then
              echo "pip could not be found, installing pip..."
              sudo apt-get update
              sudo apt-get install pip
            fi

            echo "=== Jalankan training di server untuk update models/model.pkl ==="
            if [ -f "src/training/train.py" ]; then
              sudo python3 src/training/train.py
            else
              echo "src/training/train.py tidak ditemukan di server, skip training."
            fi

            if [ -f "src/monitoring/evaluate.py" ]; then
              echo "=== Jalankan evaluate.py untuk update metrics di Pushgateway ==="
              sudo python3 src/monitoring/evaluate.py
            else
              echo "src/monitoring/evaluate.py tidak ditemukan di server, skip evaluate."
            fi

            echo "=== Deploy dengan Docker Compose (build & restart) ==="
            # ====== CEK: Apakah stack sudah pernah running ======
            if sudo docker ps | grep -q "grafana"; then
              echo "=== Stack sudah pernah running, update hanya API ==="
              sudo docker compose up -d --build api
            else
              echo "=== Stack belum ada, jalankan seluruh stack ==="
              sudo docker compose up -d --build
            fi

            echo "=== Deploy selesai. Container mlops-komoditas & stack lain jalan via docker compose ==="